generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Company/Business that installed the app
model Company {
  id                String   @id @default(cuid())
  whopCompanyId     String   @unique // biz_xxx from Whop
  name              String
  email             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSyncedAt      DateTime?

  // OAuth tokens
  accessToken       String?
  refreshToken      String?
  tokenExpiresAt    DateTime?

  // App installation data
  installedAt       DateTime @default(now())
  isActive          Boolean  @default(true)

  // Relations
  members           Member[]
  segments          Segment[]
  automations       Automation[]
  notes             Note[]
  tags              Tag[]
  dashboardInsights DashboardInsight[]
  prospects         Prospect[]
  conversations     Conversation[]
  followUpReminders FollowUpReminder[]

  @@index([whopCompanyId])
}

// Member/Customer data
model Member {
  id                String   @id @default(cuid())
  whopUserId        String   @unique // user_xxx from Whop
  email             String
  username          String?
  profilePicUrl     String?

  companyId         String
  company           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Subscription data
  status            String   // active, cancelled, past_due, etc.
  currentPlan       String?
  planId            String?  // Whop plan ID

  // Financial metrics
  totalRevenue      Float    @default(0)
  monthlyRevenue    Float    @default(0)
  lifetimeValue     Float    @default(0)

  // Engagement metrics
  lastSeenAt        DateTime?
  firstJoinedAt     DateTime @default(now())
  cancelledAt       DateTime?

  // Risk scoring
  churnRisk         String   @default("low") // low, medium, high
  engagementScore   Int      @default(0)     // 0-100

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  memberships       Membership[]
  events            Event[]
  notes             Note[]
  tags              MemberTag[]
  segmentMembers    SegmentMember[]

  @@index([companyId])
  @@index([whopUserId])
  @@index([email])
  @@index([status])
}

// Membership history (tracks subscription changes over time)
model Membership {
  id                String   @id @default(cuid())
  whopMembershipId  String   @unique // membership_xxx from Whop

  memberId          String
  member            Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  planId            String
  planName          String
  status            String

  price             Float
  currency          String   @default("usd")
  interval          String   // month, year, lifetime

  startedAt         DateTime
  renewsAt          DateTime?
  cancelledAt       DateTime?
  expiresAt         DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([memberId])
  @@index([status])
  @@index([startedAt])
}

// Event timeline for member actions
model Event {
  id          String   @id @default(cuid())
  type        String   // subscription_created, subscription_cancelled, payment_succeeded, etc.

  memberId    String
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  data        Json?    // Store webhook payload or event metadata

  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([memberId])
  @@index([type])
  @@index([occurredAt])
}

// Segments for grouping members
model Segment {
  id          String   @id @default(cuid())
  name        String
  description String?

  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Segment configuration
  filters     Json     // Store filter criteria
  isTemplate  Boolean  @default(false) // Pre-built templates vs custom

  // Computed stats
  memberCount Int      @default(0)
  totalMrr    Float    @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     SegmentMember[]

  @@index([companyId])
}

// Many-to-many relation between segments and members
model SegmentMember {
  id         String   @id @default(cuid())

  segmentId  String
  segment    Segment  @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  memberId   String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  addedAt    DateTime @default(now())

  @@unique([segmentId, memberId])
  @@index([segmentId])
  @@index([memberId])
}

// Notes attached to members
model Note {
  id         String   @id @default(cuid())
  content    String

  memberId   String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdBy  String?  // user_xxx who created the note
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([memberId])
  @@index([companyId])
}

// Tags for organizing members
model Tag {
  id         String   @id @default(cuid())
  name       String
  color      String?  // Hex color for UI

  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  members    MemberTag[]

  @@unique([companyId, name])
  @@index([companyId])
}

// Many-to-many relation between tags and members
model MemberTag {
  id        String   @id @default(cuid())

  tagId     String
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  addedAt   DateTime @default(now())
  addedBy   String?  // user_xxx who added the tag

  @@unique([tagId, memberId])
  @@index([tagId])
  @@index([memberId])
}

// Automation rules (WHEN/THEN)
model Automation {
  id          String   @id @default(cuid())
  name        String
  description String?

  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Rule configuration
  trigger     Json     // WHEN conditions
  actions     Json     // THEN actions

  isActive    Boolean  @default(true)

  // Stats
  runCount    Int      @default(0)
  lastRunAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@index([isActive])
}

// AI-generated insights for dashboard
model DashboardInsight {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Insight content
  title       String
  description String
  priority    String   // "critical", "high", "medium", "low"
  category    String   // "churn", "revenue", "engagement", "growth"

  // Associated data
  metric      String?  // e.g., "23 members", "15% increase"
  actionable  Boolean  @default(false)
  actionUrl   String?  // Link to segment or relevant page

  // Metadata
  generatedAt DateTime @default(now())
  expiresAt   DateTime? // Auto-hide after this date
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId, isActive])
  @@index([generatedAt])
}

// Prospect - Potential community owner (B2B lead)
model Prospect {
  id              String   @id @default(cuid())

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Prospect information
  name            String
  email           String?
  whopUserId      String?  // If they have a Whop account
  profilePicUrl   String?

  // Community details
  communityName   String?
  communitySize   Int?     // Number of members
  platform        String?  // Discord, Telegram, Slack, etc.
  niche           String?  // Gaming, Fitness, Education, etc.

  // Lead status
  status          String   @default("new") // new, contacted, follow_up_needed, negotiating, converted, dead
  priority        String   @default("medium") // low, medium, high, urgent

  // Contact info
  whopDmUrl       String?  // URL to Whop DM conversation
  discordHandle   String?
  twitterHandle   String?

  // Metadata
  notes           String?  // Quick notes about the prospect
  tags            String[] // Array of tags
  metadata        Json?    // Additional custom fields

  convertedAt     DateTime? // When they installed the app
  convertedToCompanyId String? // If they became a customer

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  conversations     Conversation[]
  followUpReminders FollowUpReminder[]

  @@index([companyId])
  @@index([status])
  @@index([priority])
  @@index([email])
  @@index([createdAt])
}

// Conversation - DM thread with a prospect
model Conversation {
  id              String   @id @default(cuid())

  prospectId      String
  prospect        Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Conversation details
  title           String   // Brief description of conversation topic
  status          String   @default("open") // open, closed, archived

  // Message stats
  messageCount    Int      @default(0)
  lastMessage     String?  // Preview of last message
  lastMessageAt   DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  messages        ConversationMessage[]

  @@index([prospectId])
  @@index([companyId])
  @@index([status])
  @@index([lastMessageAt])
}

// ConversationMessage - Individual message in a conversation
model ConversationMessage {
  id              String   @id @default(cuid())

  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Message content
  content         String   @db.Text
  sender          String   // "user" or "prospect"
  senderName      String?  // Name of sender for display

  // Metadata
  metadata        Json?    // Attachments, reactions, etc.

  sentAt          DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([conversationId])
  @@index([sentAt])
}

// FollowUpReminder - Reminders for following up with prospects
model FollowUpReminder {
  id              String   @id @default(cuid())

  prospectId      String
  prospect        Prospect @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Reminder details
  title           String
  description     String?
  dueAt           DateTime

  // Status
  status          String   @default("pending") // pending, completed, dismissed
  notified        Boolean  @default(false) // Whether notification was sent
  notifiedAt      DateTime?

  completedAt     DateTime?
  completedBy     String?  // user_xxx who completed it

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([prospectId])
  @@index([companyId])
  @@index([status])
  @@index([dueAt])
}
